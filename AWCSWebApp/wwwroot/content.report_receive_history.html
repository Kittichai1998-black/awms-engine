<div class="row mb-3">
    <div class="col-12">
        <h5>รายงานการรับสินค้าย้อนหลัง</h5>
    </div>
</div>

    <div class="row">

        <div class="col-12">

            <table class="table table-sm">
                <thead class="table-dark" style="position:static; top:0px;">
                    <tr>
                        <td>ว/ด/ป</td>
                        <td>BO</td>
                        <td>คลัง</td>
                        <td>รหัสสินค้า</td>
                        <td>เกรด</td>
                        <td>ลอท</td>
                        <td>เลขพาเลท</td>
                        <td>จำนวน(สินค้า)</td>
                        <td>จำนวน(พาเลท)</td>
                    </tr>
                    <tr>
                        <td><input type="text" class="form-control" id="txtTime"></td>
                        <td><input type="text" class="form-control" id="txtDocRef"></td>
                        <td><input type="text" class="form-control" id="txtWh"></td>
                        <td><input type="text" class="form-control" id="txtSku"></td>
                        <td><input type="text" class="form-control" id="txtGrade"></td>
                        <td><input type="text" class="form-control" id="txtLot"></td>
                        <td><input type="text" class="form-control" id="txtItemNo"></td>
                        <td><input type="text" class="form-control" id="txtQtySto" disabled="disabled"></td>
                        <td><input type="text" class="form-control" id="txtQtyPl" disabled="disabled"></td>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-end"><button id="btnExport" class="btn btn-secondary form-control float-end">Export to Excel</button></td>
                        <td colspan="4" class="text-end">Size:</td>
                        <td colspan="1"><input type="number" class="form-control" id="txtMax" value="25"></td>
                        <td colspan="1" class="text-end">Page:</td>
                        <td colspan="1"><input type="number" class="form-control" id="txtPage" value="1"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>


    <script>
        var dataExport = []
        $('input[id^=txt]').change(() => {
            page_load();
        });

        $('#btnExport').click(() => {
            
            if (dataExport.length == 0) {
                alert('ไม่พบข้อมูล');
                return;
            }
            console.log('dataExport', dataExport)
            var EXCEL_EXTENSION = '.xlsx';
            const fileName = 'Report_receive_historyExport_' + new Date().toISOString().substring(0, 19).replace("T", " ") + EXCEL_EXTENSION;

            var Heading = [
                ["ลำดับ", "วันที่", "คลัง", "เลขที่ BO", "ลูกค้า", "SKU", "Grade", "Lot", "สถานะ", "เลข Pallet", "จำนวน (สินค้า)", "จำนวน (Pallet)"],
            ];

            const headers = {
                rowid: 'ลำดับ'
                , time: 'วันที่'
                , wh: 'คลัง'
                , docRef: 'เลขที่ BO'
                , cus: 'ลูกค้า'
                , sku: 'SKU'
                , grade: 'Grade'
                , lot: 'Lot'
                , status: 'สถานะ'
                , itemNo: 'เลข Pallet'
                , qtySto: 'จำนวน (สินค้า)'
                , qtyPl: 'จำนวน (Pallet)'
            };

            if (typeof XLSX == 'undefined') XLSX = require('xlsx');
            //var ws = XLSX.utils.json_to_sheet(dataExport);

            dataExport.unshift(headers);

            var wb = XLSX.utils.book_new();           
            var ws = XLSX.utils.json_to_sheet(dataExport, { origin: 'A2', skipHeader: true });
            XLSX.utils.sheet_add_aoa(ws, [
                ["รายงานการรับสินค้าย้อนหลัง"]
            ], { origin: 'A1' });
            //XLSX.utils.sheet_add_aoa(ws, headers);
            
            XLSX.utils.book_append_sheet(wb, ws, "รายงานการรับสินค้าย้อนหลัง");
            XLSX.writeFile(wb, fileName);

        });

        function page_load() {
            app.get('get_sp', {
                _sp: 'rp_buwork_history',
                io: 1,
                time: $('#txtTime').val(),
                docRef: $('#txtDocRef').val(),
                wh: $('#txtWh').val(),
                sku: $('#txtSku').val(),
                grade: $('#txtGrade').val(),
                lot: $('#txtLot').val(),
                itemNo: $('#txtItemNo').val(),
                max: $('#txtMax').val(),
                page: $('#txtPage').val(),
            },
                (data) => {
                    dataExport = data.response;
                    
                    var tbody = $('#tbody');
                    tbody.html('');
                    data.response.forEach((v) => {
                        var tr = $('<tr>' +
                            '<td>' + v.time + '</td>' +
                            '<td>' + v.docRef + '</td>' +
                            '<td>' + v.wh + '</td>' +
                            '<td>' + v.sku + '</td>' +
                            '<td>' + v.grade + '</td>' +
                            '<td>' + v.lot + '</td>' +
                            '<td>' + v.itemNo + '</td>' +
                            '<td class="text-end">' + v.qtySto + '</td>' +
                            '<td class="text-end">' + v.qtyPl + '</td>' +
                            '</tr>');
                        tbody.append(tr);
                    });
                }, () => {
                });
        }
        page_load();
    </script>
